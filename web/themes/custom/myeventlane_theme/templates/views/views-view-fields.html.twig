{#
/**
 * @file
 * Default view template to display all the fields in a row.
 *
 * MyEventLane override:
 * - For Event Views, render the single canonical event card and nothing else.
 * - Otherwise, fall back to core's default fields markup.
 */
#}

{% if mel_is_event_view %}
  {# Views field output is often markup (links/wrappers). Normalize to plain values. #}

  {# URL: prefer raw, fall back to extracting href from link markup. #}
  {% set _url = fields.view_node.raw|default('') %}
  {% if not _url %}
    {% set _link_html = fields.view_node.content|default('')|render|trim %}
    {% if 'href="' in _link_html %}
      {% set _url = _link_html|split('href="')|last|split('"')|first %}
    {% elseif "href='" in _link_html %}
      {% set _url = _link_html|split("href='")|last|split("'")|first %}
    {% endif %}
  {% endif %}

  {# Image: extract src from rendered field markup if possible. #}
  {% set _image_src = '' %}
  {% set _image_html = fields.field_image.content|default('')|render|trim %}
  {% if _image_html %}
    {% if 'src="' in _image_html %}
      {% set _image_src = _image_html|split('src="')|last|split('"')|first %}
    {% elseif "src='" in _image_html %}
      {% set _image_src = _image_html|split("src='")|last|split("'")|first %}
    {% endif %}
  {% endif %}

  {% include '@myeventlane_theme/event/event-card.html.twig' with {
    title: fields.title.content|default('')|striptags|trim,
    url: _url,
    image: _image_src,
    date_day: fields.field_date_day.content|default('')|striptags|trim,
    date_month: fields.field_date_month.content|default('')|striptags|trim,
    date_full: fields.field_date.content|default('')|striptags|trim,
    location: fields.field_location.content|default('')|striptags|trim,
    category: fields.field_category.content|default('')|striptags|trim,
    category_slug: fields.field_category_slug.content|default('')|striptags|trim,
    ticket_type: fields.field_ticket_type.content|default('rsvp')|striptags|trim,
    ticket_label: fields.field_ticket_label.content|default('RSVP')|striptags|trim,
    accessibility: fields.field_accessibility_icons.content|default([])
  } only %}
{% else %}
  {% for field in fields -%}
    {{ field.separator }}
    {%- if field.wrapper_element -%}
      <{{ field.wrapper_element }}{{ field.wrapper_attributes }}>
    {%- endif %}
    {%- if field.label -%}
      {%- if field.label_element -%}
        <{{ field.label_element }}{{ field.label_attributes }}>{{ field.label }}{{ field.label_suffix }}</{{ field.label_element }}>
      {%- else -%}
        {{ field.label }}{{ field.label_suffix }}
      {%- endif %}
    {%- endif %}
    {%- if field.element_type -%}
      <{{ field.element_type }}{{ field.element_attributes }}>{{ field.content }}</{{ field.element_type }}>
    {%- else -%}
      {{ field.content }}
    {%- endif %}
    {%- if field.wrapper_element -%}
      </{{ field.wrapper_element }}>
    {%- endif %}
  {%- endfor %}
{% endif %}
