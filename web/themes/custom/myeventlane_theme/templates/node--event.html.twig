{#
/**
 * @file
 * Event node template - MEL v2 design system.
 * Poster-style hero with two-column layout.
 */
#}

{{ attach_library('myeventlane_theme/myeventlane_event_full') }}
{% if mel_lat is defined and mel_lng is defined and mel_lat and mel_lng %}
  {{ attach_library('myeventlane_location/event_map') %}
{% endif %}

<article{{ attributes.addClass('mel-event', 'mel-event--detail') }}>
  
  {# ==========================================================================
     HERO SECTION (Poster-style)
     ========================================================================== #}
  <section class="mel-event-hero">
    {% if node.hasField('field_event_image') and not node.field_event_image.isEmpty and node.field_event_image.entity %}
      {% set image_uri = node.field_event_image.entity.uri.value %}
      {% if image_uri %}
        {% set hero_image_url = file_url(image_uri) %}
        <div class="mel-event-hero__image-wrapper">
          <img
            src="{{ hero_image_url }}"
            alt="{{ node.field_event_image.alt|default(node.label) }}"
            class="mel-event-hero__image"
          />
        </div>
      {% endif %}
    {% endif %}
          <div class="mel-event-hero__scrim"></div>
          
    <div class="mel-event-hero__content">
        {# Stamp badge #}
          {% set is_tonight = false %}
          {% if node.hasField('field_event_start') and not node.field_event_start.isEmpty %}
            {% set start_date = node.field_event_start.value|date('U') %}
            {% set now = 'now'|date('U') %}
            {% set today_start = 'now'|date('Y-m-d 00:00:00')|date('U') %}
            {% set today_end = 'now'|date('Y-m-d 23:59:59')|date('U') %}
            {% if start_date >= today_start and start_date <= today_end %}
              {% set is_tonight = true %}
            {% endif %}
          {% endif %}
          
          {% if is_tonight %}
            <div class="mel-event-hero__stamp">
              <span class="mel-event-hero__stamp-text">TONIGHT</span>
            </div>
          {% elseif node.hasField('field_event_type') and not node.field_event_type.isEmpty and node.field_event_type.value == 'rsvp' %}
            <div class="mel-event-hero__stamp">
              <span class="mel-event-hero__stamp-text">FREE</span>
            </div>
          {% elseif mel_event_state is defined and mel_event_state %}
            <div class="mel-event-hero__stamp">
              <span class="mel-event-hero__stamp-text">
                {% if mel_event_state == 'live' %}
                  LIVE
                {% elseif mel_event_state == 'sold_out' %}
                  SOLD OUT
                {% elseif mel_event_state == 'cancelled' %}
                  CANCELLED
                {% endif %}
              </span>
            </div>
    {% endif %}

        <h1 class="mel-event-hero__title">{{ node.label }}</h1>
    </div>
  </section>

  {# ==========================================================================
     CANCELLED BANNER (if cancelled)
     ========================================================================== #}
  {% if mel_event_state is defined and mel_event_state == 'cancelled' %}
    <div class="mel-event-cancelled-banner">
      <div class="mel-container">
        <p class="mel-event-cancelled-banner__text">
          <strong>{{ 'This event has been cancelled.'|t }}</strong>
          {% if node.hasField('body') and not node.body.isEmpty %}
            {{ 'Please check back for updates or contact the organiser.'|t }}
          {% endif %}
        </p>
      </div>
    </div>
  {% endif %}

  {# ==========================================================================
     MAIN CONTENT GRID (Two-column desktop, single mobile)
     ========================================================================== #}
  <div class="mel-container">
    <div class="mel-event-detail-grid">
      
      {# Left Column: Main Content #}
      <div class="mel-event-detail-grid__main">
        
        {# About Section Card #}
        {% if node.hasField('body') and not node.body.isEmpty and content.body %}
          <section class="mel-event-card mel-event-card--about">
            <h2 class="mel-event-card__title">{{ 'About this event'|t }}</h2>
            <div class="mel-event-card__content">
              {{ content.body }}
            </div>
          </section>
        {% endif %}

        {# Accessibility & Inclusion Section Card #}
        {% if node.hasField('field_accessibility') and not node.field_accessibility.isEmpty %}
          <section class="mel-event-card mel-event-card--accessibility">
            <h2 class="mel-event-card__title">{{ 'Accessibility & inclusion'|t }}</h2>
            <div class="mel-event-card__content">
              {% if content.field_accessibility %}
                {% include '@myeventlane_theme/components/accessibility-icons.html.twig' with {
                  accessibility_terms: content.field_accessibility,
                  variant: 'badges',
                  show_all: true
                } only %}
              {% endif %}
              <p class="mel-helper">{{ 'Inclusive by design. If you need support, the organiser can help.'|t }}</p>
            </div>
          </section>
        {% endif %}

        {# Policies & FAQs Section Card #}
        {% set has_policies = false %}
        {% if node.hasField('field_refund_policy') and not node.field_refund_policy.isEmpty %}
          {% set has_policies = true %}
        {% endif %}
        {% if node.hasField('field_cancellation_policy') and not node.field_cancellation_policy.isEmpty %}
          {% set has_policies = true %}
        {% endif %}
        {% if has_policies %}
          <section class="mel-event-card mel-event-card--policies">
            <h2 class="mel-event-card__title">{{ 'Policies & FAQs'|t }}</h2>
            <div class="mel-event-card__content">
              {% if node.hasField('field_refund_policy') and not node.field_refund_policy.isEmpty %}
                <div class="mel-event-policy">
                  <h3 class="mel-event-policy__title">{{ 'Refund Policy'|t }}</h3>
                  <div class="mel-event-policy__content">
                    {% if node.field_refund_policy.value %}
                      {% set refund_value = node.field_refund_policy.value %}
                      {% set refund_label = refund_value|replace({
                        'none_specified': 'No specified policy on refunds'|t,
                        '1_day': 'Refunds are available up to 1 day prior to the event'|t,
                        '7_days': 'Refunds are available up to 7 days prior to the event'|t,
                        '14_days': 'Refunds are available up to 14 days prior to the event'|t,
                        '30_days': 'Refunds are available up to 30 days prior to the event'|t,
                        'no_refunds': 'No refunds'|t
                      }) %}
                      <p>{{ refund_label }}</p>
                    {% endif %}
                  </div>
                </div>
              {% endif %}
              {% if node.hasField('field_cancellation_policy') and not node.field_cancellation_policy.isEmpty %}
                <div class="mel-event-policy">
                  <h3 class="mel-event-policy__title">{{ 'Cancellation Policy'|t }}</h3>
                  <div class="mel-event-policy__content">
                    {% if content.field_cancellation_policy %}
                      {{ content.field_cancellation_policy }}
                    {% elseif node.field_cancellation_policy.value %}
                      <p>{{ node.field_cancellation_policy.value }}</p>
                    {% endif %}
                  </div>
                </div>
              {% endif %}
            </div>
          </section>
        {% endif %}

        {# Hosted by Section Card #}
        {% if event_host or mel_organiser_name %}
          <section class="mel-event-card mel-event-card--host">
            <h2 class="mel-event-card__title">{{ 'Hosted by'|t }}</h2>
            <div class="mel-event-card__content">
              <div class="mel-event-host">
                {% if event_host %}
                  <a href="{{ event_host.url }}" class="mel-event-host__link">
                    {{ event_host.name }}
                  </a>
                {% elseif mel_organiser_name %}
                  <span class="mel-event-host__name">{{ mel_organiser_name }}</span>
                {% endif %}
            </div>
          </section>
        {% endif %}

      </div>

      {# Right Column: Sticky Sidebar #}
      <aside class="mel-event-detail-grid__sidebar">
        
        {# Action Card (Sticky) #}
        <div class="mel-event-sidebar-card">
          {# Tickets Available Badge #}
          {% if event_cta and event_cta.url %}
            <div class="mel-event-sidebar-card__badge">
              {{ 'Tickets available'|t }}
            </div>
          {% endif %}

          {# Primary CTA #}
          {% if event_cta and event_cta.label %}
            <div class="mel-event-sidebar-card__section mel-event-sidebar-card__section--cta">
              {% if event_cta.url %}
                <a href="{{ event_cta.url }}" class="mel-event-sidebar-card__cta">
                  {{ event_cta.label }}
                </a>
              {% else %}
                <span class="mel-event-sidebar-card__cta mel-event-sidebar-card__cta--disabled">
                  {{ event_cta.label }}
                </span>
              {% endif %}
              
              {# Secondary CTA for "both" mode #}
              {% if event_cta_secondary and event_cta_secondary.url and event_cta_secondary.label %}
                <a href="{{ event_cta_secondary.url }}" class="mel-event-sidebar-card__cta mel-event-sidebar-card__cta--secondary">
                  {{ event_cta_secondary.label }}
                </a>
              {% endif %}
            </div>
          {% endif %}

          {# Price Summary #}
          {% if mel_price_summary is defined and mel_price_summary %}
            <div class="mel-event-sidebar-card__section mel-event-sidebar-card__section--price">
              <div class="mel-event-sidebar-card__price">{{ mel_price_summary }}</div>
            </div>
          {% endif %}

          {# Date & Time #}
          {% if node.hasField('field_event_start') and not node.field_event_start.isEmpty %}
            <div class="mel-event-sidebar-card__section">
              <h3 class="mel-event-sidebar-card__title">{{ 'Date & time'|t }}</h3>
              <time datetime="{{ node.field_event_start.value|date('c') }}" class="mel-event-sidebar-card__date">
                <div class="mel-event-sidebar-card__date-main">
                  {{ node.field_event_start.value|date('l j F Y') }}
                </div>
                <div class="mel-event-sidebar-card__date-time">
                  {{ node.field_event_start.value|date('g:ia') }}
                  {% if node.hasField('field_event_end') and not node.field_event_end.isEmpty and node.field_event_end.value %}
                    – {{ node.field_event_end.value|date('g:ia') }}
                  {% endif %}
                </div>
              </time>

              {# Calendar links #}
              {% if mel_ics_url is defined and mel_ics_url or mel_google_cal_url is defined and mel_google_cal_url %}
                <div class="mel-event-sidebar-card__calendar-links">
                  {% if mel_ics_url is defined and mel_ics_url %}
                    <a href="{{ mel_ics_url }}" 
                       download="{{ node.label|replace({' ': '_'}) }}.ics"
                       class="mel-event-sidebar-card__calendar-link">
                      {{ 'Apple / Outlook (.ics)'|t }}
                    </a>
                  {% endif %}
                  {% if mel_google_cal_url is defined and mel_google_cal_url %}
                    <a href="{{ mel_google_cal_url }}" 
                       target="_blank" 
                       rel="noopener"
                       class="mel-event-sidebar-card__calendar-link">
                      {{ 'Google Calendar'|t }}
                    </a>
                  {% endif %}
                </div>
              {% endif %}
            </div>
          {% endif %}

          {# Location #}
          {% if event_location or mel_venue or mel_address or content.field_location %}
            <div class="mel-event-sidebar-card__section">
              <h3 class="mel-event-sidebar-card__title">{{ 'Location'|t }}</h3>
              
              {# Venue Name #}
              {% if event_location and event_location.venue_name %}
                <strong class="mel-event-sidebar-card__venue">{{ event_location.venue_name }}</strong>
              {% elseif mel_venue %}
                <strong class="mel-event-sidebar-card__venue">{{ mel_venue }}</strong>
              {% endif %}
              
              {# Address (rendered under venue name) #}
              {% if event_location and event_location.address %}
                <div class="mel-event-sidebar-card__address">
                  {{ event_location.address }}
                </div>
              {% elseif mel_address %}
                <div class="mel-event-sidebar-card__address">
                  {{ mel_address }}
                </div>
              {% elseif content.field_location %}
                <div class="mel-event-sidebar-card__address">
                  {{ content.field_location }}
                </div>
              {% endif %}
              
              {# Embedded Map (rendered under address) #}
              {% if mel_lat is defined and mel_lng is defined and mel_lat and mel_lng %}
                <div class="mel-event-sidebar-card__map myeventlane-event-map-container" 
                     data-latitude="{{ mel_lat }}" 
                     data-longitude="{{ mel_lng }}" 
                     data-title="{{ node.label }}">
                </div>
              {% endif %}
              
              {# Map link (optional, after map) #}
              {% if event_location and event_location.map_url %}
                <a href="{{ event_location.map_url }}"
                   target="_blank"
                   rel="noopener"
                   class="mel-event-sidebar-card__map-link">
                  {{ 'View on map'|t }} →
                </a>
              {% elseif mel_directions_url %}
                <a href="{{ mel_directions_url }}"
                   target="_blank"
                   rel="noopener"
                   class="mel-event-sidebar-card__map-link">
                  {{ 'Get directions'|t }} →
                </a>
              {% endif %}
            </div>
          {% endif %}

        </div>
      </aside>

    </div>
  </div>

  {# ==========================================================================
     MOBILE STICKY CTA BAR
     ========================================================================== #}
  {% if event_cta and event_cta.url %}
    <div class="mel-event-cta-mobile-sticky">
      <a href="{{ event_cta.url }}"
         class="mel-event-cta-mobile-sticky__button">
        {{ event_cta.label }}
      </a>
    </div>
  {% endif %}

</article>
