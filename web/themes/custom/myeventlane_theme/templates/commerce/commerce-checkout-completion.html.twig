{#
/**
 * @file
 * Theme override for checkout completion page.
 *
 * Available variables:
 * - order_entity: The order entity.
 * - billing_information: The billing information.
 * - shipping_information: The shipping information (if applicable).
 * - payment_method: The payment method used.
 */
#}

<div class="mel-checkout-confirmation">
  <div class="mel-confirmation-icon">üéâ</div>

  <h1 class="mel-confirmation-title">Thank you for your order!</h1>

  <p class="mel-confirmation-order-number">
    Order number: <strong>{{ order_entity.getOrderNumber }}</strong>
  </p>

  <p class="mel-confirmation-message">
    We've sent a confirmation email to <strong>{{ order_entity.getEmail }}</strong>
    with your tickets, event details, and calendar file.
  </p>

  {# Event Summary #}
  {% set events = [] %}
  {% set ticket_items = [] %}
  {% set donation_total = 0.0 %}
  
  {% for item in order_entity.getItems() %}
    {% if item.bundle() == 'checkout_donation' or item.bundle() == 'platform_donation' or item.bundle() == 'rsvp_donation' %}
      {# Calculate donation total using correct method: check for NULL before calling getNumber() #}
      {% set item_price = item.getTotalPrice() %}
      {% if item_price %}
        {% set donation_total = donation_total + item_price.getNumber() %}
      {% endif %}
    {% elseif item.bundle() == 'boost' %}
      {# Boost is an admin product; do not show in confirmation. #}
    {% else %}
      {% set ticket_items = ticket_items|merge([item]) %}
      {% if item.hasField('field_target_event') and not item.get('field_target_event').isEmpty() %}
        {% set event = item.get('field_target_event').entity %}
        {% if event and event not in events %}
          {% set events = events|merge([event]) %}
        {% endif %}
      {% endif %}
    {% endif %}
  {% endfor %}

  {% if events|length > 0 %}
    <div class="mel-confirmation-events mel-mt-6">
      <h2 class="mel-confirmation-section-title">Your Events</h2>
      {% for event in events %}
        <div class="mel-confirmation-event-card mel-card mel-mt-4">
          <div class="mel-card-body">
            <h3 class="mel-event-title">{{ event.label() }}</h3>
            
            {% if event.hasField('field_event_start') and not event.get('field_event_start').isEmpty() %}
              <div class="mel-event-details">
                <div class="mel-event-date">
                  <strong>Date:</strong> {{ event.get('field_event_start').value|date('F j, Y') }}
                </div>
                {% if event.hasField('field_event_start') and event.hasField('field_event_end') %}
                  <div class="mel-event-time">
                    <strong>Time:</strong> {{ event.get('field_event_start').value|date('g:i A') }}
                    {% if not event.get('field_event_end').isEmpty() %}
                      - {{ event.get('field_event_end').value|date('g:i A') }}
                    {% endif %}
                  </div>
                {% endif %}
                {% if event.hasField('field_location') and not event.get('field_location').isEmpty() %}
                  <div class="mel-event-location">
                    <strong>Location:</strong> {{ event.get('field_location').value }}
                  </div>
                {% endif %}
              </div>
            {% endif %}

            {# Calendar Download #}
            <div class="mel-confirmation-calendar mel-mt-4">
              <a href="{{ url('myeventlane_rsvp.ics_download', {'node': event.id()}) }}" 
                 class="mel-btn mel-btn-secondary">
                üìÖ Download Calendar (.ics)
              </a>
            </div>
          </div>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  {# Ticket Details #}
  {% if ticket_items|length > 0 %}
    <div class="mel-confirmation-tickets mel-mt-6">
      <h2 class="mel-confirmation-section-title">Your Tickets</h2>
      <div class="mel-card mel-mt-4">
        <div class="mel-card-body">
          <div class="mel-checkout-order-items">
            {% for item in ticket_items %}
              <div class="mel-checkout-order-item">
                <div class="mel-checkout-order-item-info">
                  <div class="mel-checkout-order-item-title">
                    {% set pe = item.getPurchasedEntity() %}
                    {{ pe ? pe.label() : item.getTitle() }}
                  </div>
                  <div class="mel-checkout-order-item-variant">
                    Quantity: {{ item.getQuantity()|number_format(0) }}
                  </div>
                  
                  {# Attendee Names #}
                  {% if item.hasField('field_ticket_holder') and not item.get('field_ticket_holder').isEmpty() %}
                    <div class="mel-attendee-names mel-mt-2">
                      <strong>Attendees:</strong>
                      <ul class="mel-attendee-list">
                        {% for paragraph in item.get('field_ticket_holder').referencedEntities() %}
                          <li>
                            {{ paragraph.get('field_first_name').value }} 
                            {{ paragraph.get('field_last_name').value }}
                            {% if paragraph.hasField('field_email') and not paragraph.get('field_email').isEmpty() %}
                              ({{ paragraph.get('field_email').value }})
                            {% endif %}
                          </li>
                        {% endfor %}
                      </ul>
                    </div>
                  {% endif %}
                </div>
                <div class="mel-checkout-order-item-price">
                  {{ item.getTotalPrice()|commerce_price_format }}
                </div>
              </div>
            {% endfor %}
          </div>
        </div>
      </div>
    </div>
  {% endif %}

  {# Donation (if present) #}
  {% if donation_total > 0 %}
    <div class="mel-confirmation-donation mel-mt-6">
      <div class="mel-card mel-card-highlight">
        <div class="mel-card-body">
          <h3 class="mel-donation-title">üíù Your Donation</h3>
          <p class="mel-donation-amount">
            <strong>Donation Amount:</strong> ${{ donation_total|number_format(2) }}
          </p>
          <p class="mel-donation-note">
            Thank you for your generous donation! Your contribution helps support our platform and events.
          </p>
        </div>
      </div>
    </div>
  {% endif %}

  {# Order Total #}
  <div class="mel-checkout-grand-total mel-mt-6">
    <div class="mel-card">
      <div class="mel-card-body">
        <div class="mel-total-row">
          <span class="mel-total-label">Total Paid</span>
          <span class="mel-total-amount">{{ order_entity.getTotalPrice()|commerce_price_format }}</span>
        </div>
      </div>
    </div>
  </div>

  {# What Happens Next #}
  <div class="mel-confirmation-what-next mel-mt-6">
    <div class="mel-card">
      <div class="mel-card-body">
        <h2 class="mel-confirmation-section-title">{{ 'What happens next'|t }}</h2>
        
        <div class="mel-what-next-list">
          {# Confirmation Email #}
          <div class="mel-what-next-item">
            <h3 class="mel-what-next-item-title">{{ 'üìß Confirmation Email'|t }}</h3>
            <p class="mel-what-next-item-text">
              {{ 'You\'ll receive a confirmation email shortly at <strong>@email</strong> with your tickets, event details, and calendar file.'|t({'@email': order_entity.getEmail})|raw }}
            </p>
            <p class="mel-what-next-item-note">
              {{ 'If you don\'t see it, please check your spam or junk folder.'|t }}
            </p>
          </div>

          {# Your Tickets #}
          <div class="mel-what-next-item">
            <h3 class="mel-what-next-item-title">{{ 'üé´ Your Tickets'|t }}</h3>
            {% if order_entity.getCustomerId() %}
              <p class="mel-what-next-item-text">
                {{ 'Your tickets are available in your account. You can view and download them anytime.'|t }}
              </p>
            {% else %}
              <p class="mel-what-next-item-text">
                {{ 'Your tickets were sent to your email address. You can also access them using your order number: <strong>@order_number</strong>'|t({'@order_number': order_entity.getOrderNumber})|raw }}
              </p>
            {% endif %}
          </div>

          {# Event Details #}
          {% if events|length > 0 %}
            <div class="mel-what-next-item">
              <h3 class="mel-what-next-item-title">{{ 'üìÖ Event Details'|t }}</h3>
              <p class="mel-what-next-item-text">
                {{ 'All event details (date, time, location) are included in your confirmation email and can be downloaded as a calendar file (.ics) for easy access.'|t }}
              </p>
            </div>
          {% endif %}

          {# Need Help? #}
          <div class="mel-what-next-item">
            <h3 class="mel-what-next-item-title">{{ '‚ùì Need Help?'|t }}</h3>
            {% set vendor_email = null %}
            {% if events|length > 0 %}
              {% for event in events %}
                {% if event.hasField('field_event_vendor') and not event.get('field_event_vendor').isEmpty() %}
                  {% set vendor = event.get('field_event_vendor').entity %}
                  {% if vendor and vendor.hasField('field_email') and not vendor.get('field_email').isEmpty() and vendor.hasField('field_public_show_email') and vendor.get('field_public_show_email').value %}
                    {% set vendor_email = vendor.get('field_email').value %}
                    {% break %}
                  {% endif %}
                {% endif %}
              {% endfor %}
            {% endif %}
            
            {% if vendor_email %}
              <p class="mel-what-next-item-text">
                {{ 'If you have questions about this event, please contact the event organiser at <a href="mailto:@email">@email</a>.'|t({'@email': vendor_email})|raw }}
              </p>
            {% else %}
              <p class="mel-what-next-item-text">
                {{ 'If you have questions about your order or need assistance, please contact MyEventLane support.'|t }}
              </p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
  </div>

  {# Actions #}
  <div class="mel-confirmation-actions mel-mt-6">
    {% if order_entity.getCustomerId() %}
      {# Logged-in users: show "View My Tickets" link #}
      <a href="{{ url('entity.commerce_order.user_view', {'commerce_order': order_entity.id()}) }}" 
         class="mel-btn mel-btn-primary">
        View My Tickets
      </a>
    {% else %}
      {# Guest users: show clear messaging instead of broken link #}
      <div class="mel-guest-message mel-card">
        <div class="mel-card-body">
          <p class="mel-guest-message-text">
            {{ 'You don\'t need an account to attend.'|t }}
          </p>
          <p class="mel-guest-message-text">
            {{ 'Your tickets and event details have been sent to your email.'|t }}
          </p>
          <p class="mel-guest-message-text">
            {{ 'Please keep your order number handy if you need help: <strong>@order_number</strong>'|t({'@order_number': order_entity.getOrderNumber})|raw }}
          </p>
        </div>
      </div>
    {% endif %}
    <a href="{{ path('view.upcoming_events.page_events') }}" 
       class="mel-btn mel-btn-ghost">
      Browse More Events
    </a>
  </div>
</div>
