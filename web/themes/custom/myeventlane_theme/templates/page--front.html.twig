{#
  MEL v2 Front Page
  - Hero (component)
  - Featured Events (component)
  - Discover events (View render)
  - Secondary rows (Views)
#}

{% extends "page.html.twig" %}

{#
  NOTE:
  - Sections render regions that should be populated with Views blocks in Drupal.
  - Hero and Featured Events use component includes.
#}

{% block hero %}
  {% set popular_tags = popular_tags|default([]) %}
  {% include '@myeventlane_theme/components/hero/hero.twig' with { popular_tags: popular_tags } %}
{% endblock %}

{% block content %}
  {{ attach_library('myeventlane_theme/front') }}

  {# SVG filter for Liquid Glass â€” shared by all event cards #}
  <svg class="mel-liquid-glass-svg" aria-hidden="true" style="position:absolute;width:0;height:0;overflow:hidden;">
    <defs>
      <filter id="mel-liquid-glass" x="0" y="0" width="100%" height="100%" color-interpolation-filters="sRGB">
        <feTurbulence type="fractalNoise" baseFrequency="0.015" numOctaves="3" seed="2" result="noise"/>
        <feDisplacementMap in="SourceGraphic" in2="noise" scale="12" xChannelSelector="R" yChannelSelector="G" result="displaced"/>
        <feGaussianBlur in="displaced" stdDeviation="3" result="blurred"/>
        <feColorMatrix in="blurred" type="matrix"
          values="1.1 0 0 0 0.02
                  0 1.1 0 0 0.02
                  0 0 1.1 0 0.02
                  0 0 0 1 0" result="brightened"/>
      </filter>
    </defs>
  </svg>

  <div class="mel-home">
    {% if page.home_featured %}
      {% include '@myeventlane_theme/components/featured-events/featured-events.twig' with {
        title: 'Featured Events'|t,
        subtitle: null,
        view: page.home_featured
      } %}
    {% endif %}

    {% if page.home_discover %}
      <section class="mel-home-section mel-home-section--discover" aria-labelledby="mel-home-discover-title">
        <div class="mel-container">
          <div class="mel-section-head">
            <h2 id="mel-home-discover-title" class="mel-section-head__title">{{ 'Discover events'|t }}</h2>
            <a class="mel-section-head__link" href="{{ path('view.upcoming_events.page_events') }}">{{ 'View all'|t }}</a>
          </div>
          {{ page.home_discover }}
        </div>
      </section>
    {% endif %}

    {% if page.home_recommended %}
      <section class="mel-home-section mel-home-section--recommended" aria-labelledby="mel-home-recommended-title">
        <div class="mel-container">
          <div class="mel-section-head">
            <h2 id="mel-home-recommended-title" class="mel-section-head__title">{{ 'Recommended for you'|t }}</h2>
            <a class="mel-section-head__link" href="{{ path('view.upcoming_events.page_events') }}">{{ 'View all'|t }}</a>
          </div>
          {{ page.home_recommended }}
        </div>
      </section>
    {% endif %}

    {# Fallback: if no dedicated home regions are populated, render normal content. #}
    {% if not page.home_featured and not page.home_discover and not page.home_recommended %}
      <div class="mel-container">
        {{ page.content }}
      </div>
    {% endif %}
  </div>

  {# Adaptive text contrast for ALL event cards based on image brightness #}
  <script>
    (function() {
      function getImageBrightness(img, card) {
        var canvas = document.createElement('canvas');
        var ctx = canvas.getContext('2d');
        if (!ctx) return;
        var sW = 100, sH = 60;
        canvas.width = sW;
        canvas.height = sH;
        try {
          var srcY = img.naturalHeight * 0.6;
          var srcH = img.naturalHeight * 0.4;
          ctx.drawImage(img, 0, srcY, img.naturalWidth, srcH, 0, 0, sW, sH);
          var data = ctx.getImageData(0, 0, sW, sH).data;
          var total = 0, count = data.length / 4;
          for (var i = 0; i < data.length; i += 4) {
            total += (data[i] * 0.299 + data[i+1] * 0.587 + data[i+2] * 0.114);
          }
          var avg = total / count;
          if (avg > 140) {
            card.classList.add('mel-event-card--light-bg');
          } else {
            card.classList.add('mel-event-card--dark-bg');
          }
        } catch (e) {
          card.classList.add('mel-event-card--dark-bg');
        }
      }

      document.querySelectorAll('.mel-event-card').forEach(function(card) {
        var img = card.querySelector('.mel-event-card__image-element');
        if (!img) return;
        if (img.complete && img.naturalWidth > 0) {
          getImageBrightness(img, card);
        } else {
          img.addEventListener('load', function() { getImageBrightness(img, card); });
        }
      });
    })();
  </script>
{% endblock %}
