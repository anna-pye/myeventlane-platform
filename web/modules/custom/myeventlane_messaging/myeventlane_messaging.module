<?php

/**
 * @file
 * Module hooks for MyEventLane Messaging.
 */

declare(strict_types=1);

/**
 * Implements hook_cron().
 */
function myeventlane_messaging_cron(): void {
  \Drupal::state()->set('myeventlane_messaging.cron_run_count', 0);
  \Drupal::service('myeventlane_messaging.scheduler.boost')->scan();
  \Drupal::service('myeventlane_messaging.scheduler.cart')->scan();
  \Drupal::service('myeventlane_messaging.scheduler.event')->scan();
  // Scan for event reminders (7 days and 24 hours before event start).
  \Drupal::service('myeventlane_messaging.event_reminder_scheduler')->scan();
}

/**
 * Implements hook_theme().
 */
function myeventlane_messaging_theme($existing, $type, $theme, $path) {
  $tpl_path = \Drupal::service('extension.list.module')->getPath('myeventlane_messaging') . '/templates';

  return [
    'myeventlane_email' => [
      'variables' => ['body' => '', 'context' => []],
      'template' => 'myeventlane-email',
      'path' => $tpl_path,
    ],
    'myeventlane_messaging_inline' => [
      'variables' => ['template' => '', 'context' => []],
      'template' => 'myeventlane-messaging-inline',
      'path' => $tpl_path,
    ],
  ];
}

/**
 * Preprocess for myeventlane_email.
 *
 * Injects logo_path: vendor logo (context.logo_url) or theme logo fallback.
 * VendorBrandResolver provides logo_url in context when available.
 */
function template_preprocess_myeventlane_email(array &$variables): void {
  $variables['#attributes']['style'] = 'margin:0;padding:0;background:#fef5ec;';

  $context = $variables['context'] ?? [];
  $variables['preheader'] = $context['preheader'] ?? '';
  $variables['marketing'] = $context['marketing'] ?? [];
  $vendor_logo = $context['logo_url'] ?? '';

  if ($vendor_logo !== '') {
    $variables['logo_path'] = $vendor_logo;
    return;
  }

  $theme_settings = \Drupal::service(\Drupal\Core\Extension\ThemeSettingsProvider::class);
  $default_theme = \Drupal::config('system.theme')->get('default');
  $theme_logo = $theme_settings->getSetting('logo.url', $default_theme);

  if ($theme_logo !== NULL && $theme_logo !== '') {
    $variables['logo_path'] = $theme_logo;
    return;
  }

  $extension_list = \Drupal::service('extension.list.theme');
  $theme_path = $extension_list->getPath($default_theme ?: 'myeventlane_theme');
  $base_url = \Drupal::request()->getSchemeAndHttpHost() . \Drupal::request()->getBasePath();
  $variables['logo_path'] = rtrim($base_url, '/') . '/' . $theme_path . '/images/logo.svg';
}

/**
 * Implements hook_mail().
 *
 * Single generic key used by MessagingManager.
 */
function myeventlane_messaging_mail($key, &$message, $params) {
  // Handle generic and brand_test mail keys.
  if ($key !== 'generic' && $key !== 'brand_test') {
    return;
  }

  $message['subject'] = $params['subject'] ?? '(no subject)';

  // PhpMail expects body to be an array, but HTML emails need string.
  // Set body as array for PhpMail compatibility, or as string for HTML mailers.
  $body_content = $params['html'] ?? $params['body'] ?? '';
  if (is_array($body_content)) {
    $message['body'] = $body_content;
  }
  else {
    // For HTML emails, set as array with single element to satisfy PhpMail.
    $message['body'] = [$body_content];
  }

  // Ensure headers is an array.
  if (!isset($message['headers']) || !is_array($message['headers'])) {
    $message['headers'] = [];
  }
  $message['headers']['Content-Type'] = 'text/html; charset=UTF-8';

  if (!empty($params['reply_to'])) {
    $message['headers']['Reply-To'] = $params['reply_to'];
  }
  if (!empty($params['from_name']) && !empty($params['from_email'])) {
    $message['headers']['From'] = $params['from_name'] . ' <' . $params['from_email'] . '>';
  }
  elseif (!empty($params['from_email'])) {
    $message['headers']['From'] = $params['from_email'];
  }

  // Store HTML body separately for HTML mailers that need it.
  if (!empty($params['html'])) {
    $message['params']['html'] = $params['html'];
  }

  // Handle attachments.
  // Drupal's mail system supports attachments via $message['params']['attachments']
  // Format: array of arrays with 'filecontent', 'filename', and optionally 'filemime'.
  if (!empty($params['attachments']) && is_array($params['attachments'])) {
    if (!isset($message['params'])) {
      $message['params'] = [];
    }
    if (!isset($message['params']['attachments'])) {
      $message['params']['attachments'] = [];
    }

    foreach ($params['attachments'] as $attachment) {
      if (isset($attachment['filename']) && isset($attachment['content'])) {
        $message['params']['attachments'][] = [
          'filecontent' => $attachment['content'],
          'filename' => $attachment['filename'],
          'filemime' => $attachment['mime'] ?? 'text/calendar',
        ];
      }
    }
  }
}

/**
 * Implements hook_mail_alter().
 *
 * Applies vendor brand settings to ALL outgoing emails.
 * This ensures consistent branding regardless of which module sends the email.
 *
 * Resolution order for vendor context:
 * 1. Explicit vendor_id in params
 * 2. Vendor entity in params
 * 3. Event ID in params → load event → field_event_vendor
 * 4. Order in params → resolve vendor from order
 * 5. Node (event) in params → field_event_vendor
 * 6. Fallback to MEL defaults
 */
function myeventlane_messaging_mail_alter(array &$message): void {
  // Skip if brand already applied (via MessagingManager path).
  if (!empty($message['params']['mel_brand_applied'])) {
    return;
  }

  // Build context from available params.
  $params = $message['params'] ?? [];
  $context = [];

  // Check for explicit vendor context.
  if (!empty($params['vendor_id']) && is_numeric($params['vendor_id'])) {
    $context['vendor_id'] = (int) $params['vendor_id'];
  }
  if (!empty($params['vendor']) && is_object($params['vendor'])) {
    $context['vendor'] = $params['vendor'];
  }

  // Check for event context.
  if (!empty($params['event_id']) && is_numeric($params['event_id'])) {
    $context['event_id'] = (int) $params['event_id'];
  }
  if (!empty($params['event']) && $params['event'] instanceof \Drupal\node\NodeInterface) {
    $context['event'] = $params['event'];
  }
  // Also check 'node' param (common in Drupal mail).
  if (empty($context['event']) && !empty($params['node']) && $params['node'] instanceof \Drupal\node\NodeInterface) {
    $node = $params['node'];
    if ($node->bundle() === 'event') {
      $context['event'] = $node;
    }
  }

  // Check for order context (Commerce).
  if (!empty($params['order']) && is_object($params['order'])) {
    $context['order'] = $params['order'];
  }
  if (!empty($params['commerce_order']) && is_object($params['commerce_order'])) {
    $context['order'] = $params['commerce_order'];
  }

  // Resolve brand using the BrandResolver service.
  try {
    /** @var \Drupal\myeventlane_messaging\Service\BrandResolverInterface $brandResolver */
    $brandResolver = \Drupal::service('myeventlane_messaging.vendor_brand_resolver');
    $brand = $brandResolver->resolve($context);
    $brandArray = $brand->toArray();
  }
  catch (\Exception $e) {
    // Fallback to defaults if service unavailable.
    $brandArray = [
      'from_name' => 'MyEventLane',
      'from_email' => '',
      'reply_to' => '',
      'footer_text' => "You're receiving this because you interacted with MyEventLane.",
      'accent_color' => '#f26d5b',
      'logo_url' => '',
    ];
  }

  // Ensure headers array exists.
  if (!isset($message['headers']) || !is_array($message['headers'])) {
    $message['headers'] = [];
  }

  // Apply From header if vendor has custom from_email.
  // Only override if not already set by the sending module.
  if (!empty($brandArray['from_email']) && empty($message['headers']['From'])) {
    $fromName = $brandArray['from_name'] ?: 'MyEventLane';
    $fromEmail = $brandArray['from_email'];
    $message['headers']['From'] = "{$fromName} <{$fromEmail}>";
  }

  // Apply Reply-To if vendor has custom reply_to.
  // Only override if not already set.
  if (!empty($brandArray['reply_to']) && empty($message['headers']['Reply-To'])) {
    $message['headers']['Reply-To'] = $brandArray['reply_to'];
  }

  // Inject brand variables into params for template use.
  $message['params']['mel_brand'] = [
    'from_name' => $brandArray['from_name'] ?? 'MyEventLane',
    'accent_color' => $brandArray['accent_color'] ?? '#f26d5b',
    'logo_url' => $brandArray['logo_url'] ?? '',
    'footer_text' => $brandArray['footer_text'] ?? '',
    'vendor_id' => $brandArray['vendor_id'] ?? NULL,
    'source' => $brandArray['source'] ?? 'default',
  ];

  // Mark as applied to prevent double-processing.
  $message['params']['mel_brand_applied'] = TRUE;
}
