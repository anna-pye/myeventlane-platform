<?php

/**
 * @file
 * Capacity engine module for MyEventLane.
 */

declare(strict_types=1);

use Drupal\myeventlane_capacity\Exception\CapacityExceededException;
use Drupal\commerce_order\Entity\OrderInterface;
use Drupal\Core\Form\FormStateInterface;
use Drupal\Core\Entity\EntityInterface;
use Drupal\node\NodeInterface;

/**
 * Implements hook_entity_insert().
 */
function myeventlane_capacity_entity_insert(EntityInterface $entity): void {
  myeventlane_capacity_invalidate_event_cache($entity);
}

/**
 * Implements hook_entity_update().
 */
function myeventlane_capacity_entity_update(EntityInterface $entity): void {
  myeventlane_capacity_invalidate_event_cache($entity);
}

/**
 * Implements hook_entity_delete().
 */
function myeventlane_capacity_entity_delete(EntityInterface $entity): void {
  myeventlane_capacity_invalidate_event_cache($entity);
}

/**
 * Implements hook_form_alter().
 */
function myeventlane_capacity_form_alter(array &$form, FormStateInterface $form_state, string $form_id): void {
  // Add capacity validation to cart form.
  if ($form_id === 'commerce_cart_form') {
    $form['#validate'][] = 'myeventlane_capacity_cart_form_validate';
  }
}

/**
 * Validates cart form for capacity enforcement.
 *
 * @param array $form
 *   The form array.
 * @param \Drupal\Core\Form\FormStateInterface $form_state
 *   The form state.
 */
function myeventlane_capacity_cart_form_validate(array &$form, FormStateInterface $form_state): void {
  if (!\Drupal::hasService('myeventlane_capacity.service')) {
    return;
  }

  $capacity_service = \Drupal::service('myeventlane_capacity.service');
  $order_inspector = \Drupal::service('myeventlane_capacity.order_inspector');
  $entity_type_manager = \Drupal::entityTypeManager();

  // Get the cart order from form state.
  $cart = $form_state->get('cart');
  if (!$cart instanceof OrderInterface) {
    return;
  }

  // Extract event quantities from the cart.
  $event_quantities = $order_inspector->extractEventQuantities($cart);
  if (empty($event_quantities)) {
    // No ticket items, no capacity check needed.
    return;
  }

  // Load all events in bulk.
  $event_ids = array_keys($event_quantities);
  $event_storage = $entity_type_manager->getStorage('node');
  $events = $event_storage->loadMultiple($event_ids);

  // Enforce capacity for each event.
  foreach ($event_quantities as $event_id => $requested_total) {
    if ($requested_total <= 0) {
      continue;
    }

    $event_node = $events[$event_id] ?? NULL;
    if (!$event_node instanceof NodeInterface || $event_node->bundle() !== 'event') {
      continue;
    }

    // Check if event has capacity limits (NULL = unlimited).
    $capacity_total = $capacity_service->getCapacityTotal($event_node);
    if ($capacity_total === NULL) {
      // Unlimited capacity, allow.
      continue;
    }

    // Enforce capacity.
    try {
      $capacity_service->assertCanBook($event_node, $requested_total);
    }
    catch (CapacityExceededException $e) {
      // Get remaining capacity for user-friendly message.
      $remaining = $capacity_service->getRemaining($event_node);
      if ($remaining !== NULL && $remaining > 0) {
        $message = t('Sorry, only @remaining ticket(s) remaining for "@event". Please adjust your quantity.', [
          '@remaining' => $remaining,
          '@event' => $event_node->label(),
        ]);
      }
      else {
        $message = t('Sorry, "@event" is sold out. Please try another event.', [
          '@event' => $event_node->label(),
        ]);
      }

      // Set form error on the cart form.
      $form_state->setError($form, $message);

      // Log the blocked cart update.
      \Drupal::logger('myeventlane_capacity')->warning(
        'Capacity enforcement blocked cart update: cart @cart_id, event @event_id, requested @qty',
        [
          '@cart_id' => $cart->id(),
          '@event_id' => $event_id,
          '@qty' => $requested_total,
        ]
      );
    }
  }
}

/**
 * Invalidates capacity cache for related events.
 */
function myeventlane_capacity_invalidate_event_cache(EntityInterface $entity): void {
  if (!\Drupal::hasService('myeventlane_capacity.service')) {
    return;
  }

  $capacityService = \Drupal::service('myeventlane_capacity.service');
  $eventId = NULL;

  // RSVP submission.
  if ($entity->getEntityTypeId() === 'rsvp_submission') {
    if ($entity->hasField('event_id') && !$entity->get('event_id')->isEmpty()) {
      $eventId = (int) $entity->get('event_id')->target_id;
    }
  }

  // Commerce order item.
  if ($entity->getEntityTypeId() === 'commerce_order_item') {
    if ($entity->hasField('field_target_event') && !$entity->get('field_target_event')->isEmpty()) {
      $eventId = (int) $entity->get('field_target_event')->target_id;
    }
  }

  // Commerce order - check items.
  if ($entity->getEntityTypeId() === 'commerce_order') {
    try {
      foreach ($entity->getItems() as $item) {
        if ($item->hasField('field_target_event') && !$item->get('field_target_event')->isEmpty()) {
          $eventId = (int) $item->get('field_target_event')->target_id;
          if ($eventId) {
            $capacityService->invalidateCache($eventId);
          }
        }
      }
    }
    catch (\Exception $e) {
      // Ignore errors.
    }
    return;
  }

  // Event node.
  if ($entity instanceof NodeInterface && $entity->bundle() === 'event') {
    $eventId = (int) $entity->id();
  }

  if ($eventId) {
    $capacityService->invalidateCache($eventId);
  }
}
