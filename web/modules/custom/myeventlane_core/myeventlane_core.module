<?php

declare(strict_types=1);

/**
 * @file
 * Core services and utilities for MyEventLane platform.
 *
 * This module provides shared services used throughout MyEventLane:
 * - myeventlane_core.date_formatter: Date formatting utilities for events.
 * - myeventlane_core.route_helper: Route lookup and URL generation helpers.
 */

use Drupal\Core\Access\AccessResult;
use Drupal\Core\Session\AccountInterface;
use Drupal\Core\Entity\EntityInterface;

/**
 * Implements hook_theme().
 */
function myeventlane_core_theme(): array {
  return [
    'myeventlane_my_categories' => [
      'variables' => [
        'followed_categories' => [],
      ],
      'template' => 'myeventlane-my-categories',
    ],
    'myeventlane_category_digest_email' => [
      'variables' => [
        'user' => NULL,
        'events_by_category' => [],
      ],
      'template' => 'myeventlane-category-digest-email',
    ],
    'customer_onboard_step' => [
      'variables' => [
        'step_number' => 1,
        'total_steps' => 4,
        'step_title' => NULL,
        'step_description' => NULL,
        'content' => NULL,
      ],
      'template' => 'customer-onboard-step',
    ],
  ];
}

/**
 * Implements hook_mail().
 */
function myeventlane_core_mail($key, &$message, $params): void {
  switch ($key) {
    case 'category_digest':
      $message['subject'] = $params['subject'] ?? t('Weekly Event Digest - New events in your categories');
      $message['body'][] = $params['body'] ?? '';
      $message['headers']['Content-Type'] = 'text/html; charset=UTF-8';
      break;
  }
}

/**
 * Implements hook_cron().
 */
function myeventlane_core_cron(): void {
  \Drupal::service('myeventlane_core.category_digest_cron')->runSundayDigest();
}

/**
 * Implements hook_entity_access().
 *
 * Ensures administrators can access Commerce payment methods.
 */
function myeventlane_core_entity_access(EntityInterface $entity, string $operation, AccountInterface $account): AccessResult {
  // Only handle Commerce payment method entities.
  if ($entity->getEntityTypeId() !== 'commerce_payment_method') {
    return AccessResult::neutral();
  }

  // Administrators (UID 1 or has 'administer site configuration') always have access.
  if ($account->id() === 1 || $account->hasPermission('administer site configuration')) {
    return AccessResult::allowed()->cachePerPermissions();
  }

  // Let Commerce handle access for other users.
  return AccessResult::neutral();
}

/**
 * Implements hook_entity_presave().
 *
 * Fixes Layout Builder entity view display dependency calculation issue.
 * Ensures view modes exist before saving to prevent null reference errors.
 *
 * This workaround fixes a core bug where calculateDependencies() calls
 * getConfigDependencyName() on a null view mode entity.
 */
function myeventlane_core_entity_presave(EntityInterface $entity): void {
  \Drupal::service('myeventlane_core.entity_view_display_presave')->presave($entity);
}

/**
 * Implements hook_views_post_execute().
 *
 * Log commerce_cart_form result count for debugging empty cart table.
 */
function myeventlane_core_views_post_execute(\Drupal\views\ViewExecutable $view): void {
  if ($view->id() !== 'commerce_cart_form') {
    return;
  }
  \Drupal::logger('myeventlane_core')->info('commerce_cart_form: args=@args result_count=@c', [
    '@args' => implode(',', array_map('strval', $view->args)),
    '@c' => count($view->result),
  ]);
}
