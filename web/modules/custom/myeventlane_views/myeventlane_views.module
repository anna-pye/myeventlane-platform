<?php

/**
 * @file
 * MyEventLane Views module.
 */

use Drupal\views\ViewExecutable;
use Twig\Loader\FilesystemLoader;

/**
 * Implements hook_twig_loader_alter().
 *
 * Adds a stable Twig namespace alias used by canonical theme includes.
 */
function myeventlane_views_twig_loader_alter(FilesystemLoader $loader): void {
  try {
    $theme_path = \Drupal::service('extension.list.theme')->getPath('myeventlane_theme');
    $templates_path = DRUPAL_ROOT . '/' . $theme_path . '/templates';

    // Allows includes like: @myeventlane/event/event-card.html.twig
    $loader->addPath($templates_path, 'myeventlane');
  }
  catch (\Throwable $e) {
    // If the theme path cannot be resolved, do nothing.
  }
}

/**
 * Implements hook_views_post_execute().
 *
 * Ensures null field values are converted to empty strings to prevent
 * Html::escape() errors when rendering Views fields.
 */
function myeventlane_views_views_post_execute(ViewExecutable $view): void {
  foreach ($view->result as $index => $row) {
    foreach ($view->field as $field_id => $field) {
      if (isset($field->field_alias)) {
        $alias = $field->field_alias;
        if (isset($row->{$alias}) && $row->{$alias} === NULL) {
          $row->{$alias} = '';
        }
      }
    }
  }
}

/**
 * Implements hook_views_pre_render().
 *
 * - Sorts upcoming_events by promoted (featured) first.
 * - Ensures null field values are converted to empty strings.
 */
function myeventlane_views_views_pre_render(ViewExecutable $view): void {
  // Sort upcoming_events: featured first, preserve existing order within groups.
  if ($view->id() === 'upcoming_events' && !empty($view->result)) {
    usort($view->result, function ($a, $b) {
      $promo_a = 0;
      $promo_b = 0;
      if (isset($a->_entity) && $a->_entity->hasField('field_promoted') && !$a->_entity->get('field_promoted')->isEmpty()) {
        $promo_a = (int) $a->_entity->get('field_promoted')->value;
      }
      if (isset($b->_entity) && $b->_entity->hasField('field_promoted') && !$b->_entity->get('field_promoted')->isEmpty()) {
        $promo_b = (int) $b->_entity->get('field_promoted')->value;
      }
      if ($promo_a !== $promo_b) {
        return $promo_b - $promo_a;
      }
      return 0;
    });
  }

  // Null conversion for all views.
  foreach ($view->result as $index => $row) {
    foreach ($view->field as $field_id => $field) {
      if (isset($field->field_alias)) {
        $alias = $field->field_alias;
        if (isset($row->{$alias}) && $row->{$alias} === NULL) {
          $row->{$alias} = '';
        }
      }
    }
  }
}

/**
 * Implements template_preprocess_views_view_field().
 *
 * Ensures null values are converted to empty strings to prevent
 * Html::escape() errors when rendering Views fields.
 */
function myeventlane_views_preprocess_views_view_field(array &$variables): void {
  // Convert null output to empty string to prevent Html::escape() errors.
  if ($variables['output'] === NULL) {
    $variables['output'] = '';
  }
  // Also check if output is a render array with null values.
  if (is_array($variables['output'])) {
    array_walk_recursive($variables['output'], function (&$value) {
      if ($value === NULL) {
        $value = '';
      }
    });
  }
}
