# Phase 7: My Tickets Self-Service Experience

**Date:** 2024-12-27  
**Status:** âœ… Complete  
**Goal:** Implement Humanitix-style "My Tickets" self-service experience for customers

---

## Summary

Phase 7 implements a comprehensive "My Tickets" experience that allows customers to:

1. **View all their ticket orders** - Grouped by upcoming vs past events
2. **Access order details** - Event info, tickets, attendees, donations
3. **Download calendar files** - Re-download .ics files for events
4. **View attendee information** - Read-only access to attendee data

All access control relies on Commerce entity access - no manual checks needed.

---

## Implementation Details

### Task 1: "My Tickets" Overview Page âœ…

**File:** `web/modules/custom/myeventlane_checkout_flow/src/Controller/MyTicketsController.php`

**Route:** `/my-tickets`

**Features:**
- Lists all orders for logged-in user
- Groups orders by upcoming vs past events
- Upcoming events shown first
- Past events collapsed in `<details>` element
- Each order card shows:
  - Event name(s) with links
  - Event date/time/location
  - Order number
  - Order status
  - Total paid
  - "View Details" CTA
  - Calendar download button (one per event)

**Access Control:**
- Anonymous users see login prompt
- Only order owner can see their orders
- Uses Commerce entity access (`accessCheck(TRUE)`)

**Template:** `myeventlane-my-tickets.html.twig`

---

### Task 2: Order Detail Page âœ…

**File:** `web/modules/custom/myeventlane_checkout_flow/src/Controller/MyTicketsController.php`

**Route:** `/my-tickets/order/{commerce_order}`

**Features:**
- Full order details for customer
- Event information (date, time, location)
- Ticket breakdown with attendee names
- Donation section (if present)
- Order total
- Calendar download button
- "Back to My Tickets" link

**Access Control:**
- Uses Commerce entity access: `_entity_access: 'commerce_order.view'`
- No manual access checks needed
- Customers can only view their own orders

**Template:** `myeventlane-order-detail.html.twig`

**Read-Only:**
- All data is read-only
- No edit actions
- Attendee data displayed but not editable
- Relies on Phase 4 access control for attendee paragraphs

---

### Task 3: Calendar Re-Download âœ…

**Implementation:**
- Reuses existing `myeventlane_rsvp.ics_download` route
- Links provided on:
  - My Tickets overview page (per event)
  - Order detail page (per event)
- Route: `/event/{node}/ics`
- Access controlled by entity access (event view permission)

**ICS Files:**
- Generated by `myeventlane_rsvp.ics_generator` service
- One file per event
- Compatible with: Apple Calendar, Google Calendar, Outlook

---

### Task 4: UX & Theming âœ…

**Templates:**
1. `myeventlane-my-tickets.html.twig` - Overview page
2. `myeventlane-order-detail.html.twig` - Order detail page

**Design Features:**
- Mobile-first responsive layout
- MEL pastel color scheme
- Card-based design for orders and events
- Clear visual hierarchy
- Touch-friendly buttons (44x44 minimum)
- Empty state messaging
- Collapsible past events section

**Styling Classes:**
- `mel-my-tickets` - Main container
- `mel-order-card` - Order card styling
- `mel-event-card` - Event card styling
- `mel-btn`, `mel-btn-primary`, `mel-btn-secondary` - Button styles
- `mel-card`, `mel-card-body` - Card components
- `mel-section`, `mel-section-title` - Section styling

---

### Task 5: Documentation & Verification âœ…

**File:** `docs/phase-7-my-tickets.md` (this file)

**Manual Test Steps:**

1. **My Tickets Overview:**
   - Log in as customer
   - Navigate to `/my-tickets`
   - Verify upcoming orders appear first
   - Verify past orders are collapsed
   - Verify each order shows event name, date, order number
   - Verify "View Details" link works
   - Verify calendar download button works
   - Test as anonymous user (should see login prompt)

2. **Order Detail Page:**
   - Click "View Details" on an order
   - Verify event details display correctly
   - Verify ticket breakdown with attendee names
   - Verify donation section (if present)
   - Verify order total
   - Verify calendar download button
   - Verify "Back to My Tickets" link
   - Try to access another user's order (should get 403)

3. **Calendar Download:**
   - Click calendar download button
   - Verify .ics file downloads
   - Open in Apple Calendar (should import)
   - Open in Google Calendar (should import)
   - Verify event details are correct

4. **Edge Cases:**
   - Order with no events (should handle gracefully)
   - Order with multiple events (should show all)
   - Order with donation (should show donation section)
   - Order with no attendees (should handle gracefully)
   - User with no orders (should show empty state)

---

## Files Created/Modified

### New Files:
1. `src/Controller/MyTicketsController.php` - Controller for My Tickets pages
2. `myeventlane_checkout_flow.module` - Theme hooks
3. `myeventlane_checkout_flow.routing.yml` - Routes (if not already exists)
4. `templates/myeventlane-my-tickets.html.twig` - Overview page template
5. `templates/myeventlane-order-detail.html.twig` - Order detail template
6. `docs/phase-7-my-tickets.md` - Documentation

### Modified Files:
1. `myeventlane_checkout_flow.routing.yml` - Added routes (if file existed)

---

## Route Configuration

```yaml
myeventlane_checkout_flow.my_tickets:
  path: '/my-tickets'
  defaults:
    _controller: '\Drupal\myeventlane_checkout_flow\Controller\MyTicketsController::overview'
    _title: 'My Tickets'
  requirements:
    _permission: 'access content'
    _custom_access: '\Drupal\myeventlane_checkout_flow\Controller\MyTicketsController::checkAccess'

myeventlane_checkout_flow.order_detail:
  path: '/my-tickets/order/{commerce_order}'
  defaults:
    _controller: '\Drupal\myeventlane_checkout_flow\Controller\MyTicketsController::orderDetail'
    _title_callback: '\Drupal\myeventlane_checkout_flow\Controller\MyTicketsController::orderDetailTitle'
  requirements:
    _entity_access: 'commerce_order.view'
    commerce_order: \d+
  options:
    parameters:
      commerce_order:
        type: entity:commerce_order
```

---

## Access Control

### Overview Page
- **Access:** Custom access callback checks if user is logged in
- **Data:** Uses `accessCheck(TRUE)` in entity queries
- **Result:** Only shows orders owned by current user

### Order Detail Page
- **Access:** Commerce entity access (`commerce_order.view`)
- **Result:** Customers can only view their own orders
- **No manual checks:** Relies entirely on entity access system

### Attendee Data
- **Access:** Phase 4 access control applies
- **Result:** Customers can view attendee paragraphs from their own orders
- **Read-only:** No edit actions available

---

## Data Structure

### Order Data Array

```php
[
  'order' => OrderInterface,
  'order_id' => int,
  'order_number' => string,
  'order_url' => string,
  'placed_date' => string,
  'state' => string,
  'total_price' => float,
  'events' => [
    [
      'id' => int,
      'title' => string,
      'url' => string,
      'ics_url' => string,
      'start_date' => string,
      'start_time' => string,
      'start_timestamp' => int,
      'end_date' => string|null,
      'end_time' => string|null,
      'location' => string|null,
    ],
  ],
  'ticket_items' => [
    [
      'title' => string,
      'quantity' => int,
      'price' => float,
      'attendees' => [
        ['name' => string, 'email' => string],
      ],
    ],
  ],
  'donation_total' => float,
  'has_upcoming_events' => bool,
]
```

---

## UI Components

### Order Card (Overview Page)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Event Name (link)                  â”‚
â”‚  ğŸ“… Date | Time | ğŸ“ Location        â”‚
â”‚                                     â”‚
â”‚  Order: #12345 | Placed: Jan 1     â”‚
â”‚  Status: Completed                  â”‚
â”‚  Total: $120.00                     â”‚
â”‚                                     â”‚
â”‚  [View Details] [ğŸ“… Download]        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Order Detail Page
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â† Back to My Tickets               â”‚
â”‚  Order #12345                       â”‚
â”‚  Placed: Jan 1, 2024 | Completed    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Your Events                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Event Name                  â”‚   â”‚
â”‚  â”‚ Date: Jan 15, 2024          â”‚   â”‚
â”‚  â”‚ Time: 6:00 PM - 9:00 PM     â”‚   â”‚
â”‚  â”‚ Location: Venue             â”‚   â”‚
â”‚  â”‚ [ğŸ“… Download] [View Event]  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Your Tickets                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ General Admission    $100  â”‚   â”‚
â”‚  â”‚ Quantity: 2                â”‚   â”‚
â”‚  â”‚ Attendees:                â”‚   â”‚
â”‚  â”‚   â€¢ John Doe (john@...)   â”‚   â”‚
â”‚  â”‚   â€¢ Jane Doe (jane@...)   â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ’ Your Donation                   â”‚
â”‚  Donation Amount: $20.00            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Total Paid: $120.00                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Edge Cases Handled

âœ… **No orders** - Shows empty state with "Browse Events" CTA

âœ… **No events** - Handles orders without event references gracefully

âœ… **Multiple events** - Shows all events in order

âœ… **Past events** - Collapsed in details element

âœ… **No attendees** - Attendee list only shown if attendees exist

âœ… **Missing event data** - Gracefully handles missing date/time/location

âœ… **Anonymous users** - Redirected to login

âœ… **Other users' orders** - 403 error via entity access

---

## Security Considerations

1. **Entity access** - All access control via Commerce entity access
2. **No manual checks** - Relies on Drupal's access system
3. **Read-only** - No edit actions available
4. **Attendee access** - Phase 4 access control applies
5. **Order ownership** - Only order owner can view

---

## Integration Points

- **Commerce Orders** - Uses Commerce order entities
- **Attendee Paragraphs** - Reads from `field_ticket_holder` paragraphs
- **ICS Service** - Reuses `myeventlane_rsvp.ics_generator`
- **Event Nodes** - Links to event pages
- **Entity Access** - Relies on Commerce access control

---

## Next Steps

- **Future:** Add ticket PDF download
- **Future:** Add wallet pass links
- **Future:** Add refund request functionality
- **Future:** Add order cancellation (if applicable)

---

**END OF PHASE 7 DOCUMENTATION**

