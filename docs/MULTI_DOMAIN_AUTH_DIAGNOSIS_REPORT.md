# Multi-Domain Authentication Diagnosis Report
**MyEventLane v2 ‚Äî DDEV Multi-Domain Setup**  
**Date:** 2025-01-27  
**Issue:** User authenticated on public domain appears as anonymous (UID 0) on vendor domain

---

## EXECUTIVE SUMMARY

**Root Cause Probability Ranking:**
1. **üî¥ CRITICAL (95% confidence):** Session cookie configuration conflict prevents cross-domain cookie sharing
2. **üü° PROBABLE (60% confidence):** Session not initialized/loaded on vendor domain request
3. **üü¢ POSSIBLE (30% confidence):** Access result caching across user contexts

---

## STEP 1 ‚Äî SESSION COOKIE CONFIGURATION VERIFICATION

### ‚úÖ CONFIRMED FACTS

**File:** `web/sites/default/settings.php` (lines 58-74)
```php
if (getenv('IS_DDEV_PROJECT') === 'true') {
  $settings['session.storage.options']['cookie_domain'] = '.myeventlane.ddev.site';
  $settings['session.storage.options']['cookie_samesite'] = 'None';
  $settings['session.storage.options']['cookie_secure'] = TRUE;
}
```

**File:** `web/sites/default/settings.ddev.php` (lines 49-54)
```php
$settings['session.storage.options'] = [
  'cookie_domain' => '.myeventlane.ddev.site',
  'cookie_path' => '/',
  'cookie_secure' => FALSE,  // ‚ö†Ô∏è OVERRIDES settings.php
  'cookie_samesite' => 'Lax', // ‚ö†Ô∏è OVERRIDES settings.php
];
```

**File Load Order:**
1. `settings.php` (lines 1-106)
2. `settings.ddev.php` (included at line 88-90)
3. `settings.local.php` (included at line 99-101, **NOT PRESENT**)

### ‚ùå CRITICAL FINDING: CONFIGURATION OVERRIDE

**Problem:** `settings.ddev.php` **OVERWRITES** the session configuration set in `settings.php` because:
- It is included **AFTER** `settings.php` (line 88-90)
- It uses array assignment (`=`) instead of array merge
- It changes `cookie_samesite` from `'None'` to `'Lax'`
- It changes `cookie_secure` from `TRUE` to `FALSE`

**Impact:**
- `cookie_samesite: 'Lax'` **prevents** cookies from being sent on cross-site requests
- When user navigates from `myeventlane.ddev.site` ‚Üí `vendor.myeventlane.ddev.site`, the browser **will not send** the session cookie
- Result: Drupal treats the request as anonymous (UID 0)

**Evidence:**
- `settings.ddev.php` is auto-generated by DDEV and may be overwritten
- The configuration explicitly sets incompatible values for cross-domain cookies
- Modern browsers (Chrome 80+, Safari 13+) enforce SameSite=Lax by default for cross-site requests

### ‚úÖ VERIFIED VALUES (Final Active Configuration)

Based on file load order, the **ACTIVE** session configuration is:
- `cookie_domain`: `.myeventlane.ddev.site` ‚úÖ (correct)
- `cookie_path`: `/` ‚úÖ (correct)
- `cookie_samesite`: `'Lax'` ‚ùå (blocks cross-domain)
- `cookie_secure`: `FALSE` ‚ö†Ô∏è (acceptable for DDEV local, but conflicts with SameSite=None requirement)

---

## STEP 2 ‚Äî AUTHENTICATION STATE AT KERNEL.REQUEST

### ‚úÖ CONFIRMED FACTS

**VendorDomainSubscriber Configuration:**
- Priority: `30` on `KernelEvents::REQUEST`
- Location: `web/modules/custom/myeventlane_core/src/EventSubscriber/VendorDomainSubscriber.php`
- Runs: Early in request lifecycle, **after** session initialization (typically priority 0-20)

**Drupal Authentication Load Order:**
1. `KernelEvents::REQUEST` priority 0-20: Session initialization, user loading
2. `KernelEvents::REQUEST` priority 30: **VendorDomainSubscriber runs here**
3. `KernelEvents::REQUEST` priority 100+: Route matching, access checks

### ‚ö†Ô∏è HYPOTHESIS: SESSION NOT LOADED

**Scenario:** If session cookie is not sent by browser (due to SameSite=Lax), then:
- Drupal's session handler receives no session ID
- `AccountProxyInterface` loads anonymous user (UID 0)
- `VendorDomainSubscriber::onRequest()` sees `$this->currentUser->isAnonymous() === TRUE`
- User is redirected to login, creating a **new session** on vendor domain

**Evidence Needed:**
- Log output from `VendorDomainSubscriber::onRequest()` will show:
  - `uid: 0` (if session not loaded)
  - `session_id: NO_SESSION` or different session ID than public domain

### üß™ DIAGNOSTIC INSTRUMENTATION ADDED

**File:** `web/modules/custom/myeventlane_core/src/EventSubscriber/VendorDomainSubscriber.php` (lines 106-120)

Added logging to track:
- Host (domain)
- Path
- Route name
- UID
- Authentication state
- Session ID (truncated)

**To Verify:**
1. Clear Drupal cache: `ddev drush cr`
2. Log in on public domain: `myeventlane.ddev.site/user/login`
3. Navigate to vendor domain: `vendor.myeventlane.ddev.site/vendor/dashboard`
4. Check logs: `ddev drush wd-show vendor_domain_diagnostic`

**Expected Log Pattern if Session Not Shared:**
```
VendorDomainSubscriber::onRequest
  host: vendor.myeventlane.ddev.site
  path: /vendor/dashboard
  uid: 0
  is_authenticated: FALSE
  session_id: [DIFFERENT_OR_NO_SESSION]
```

---

## STEP 3 ‚Äî ROUTE ACCESS STACK TRACE

### ‚úÖ CONFIRMED FACTS

**Route Definition:**
- **Route Name:** `myeventlane_vendor.console.dashboard`
- **Path:** `/vendor/dashboard`
- **File:** `web/modules/custom/myeventlane_vendor/myeventlane_vendor.routing.yml` (lines 218-225)
- **Access Check:** `_custom_access: '\Drupal\myeventlane_vendor\Access\VendorConsoleAccess::access'`

**Access Check Implementation:**
- **File:** `web/modules/custom/myeventlane_vendor/src/Access/VendorConsoleAccess.php`
- **Method:** `VendorConsoleAccess::access(RouteMatchInterface $route_match, AccountInterface $account)`
- **Logic:**
  1. Check if `$account->id() === 1` OR has `'administer site configuration'` ‚Üí ALLOW
  2. Check if has `'access vendor console'` permission ‚Üí ALLOW
  3. Otherwise ‚Üí FORBIDDEN

### ‚ö†Ô∏è ACCESS EVALUATION ORDER

**Drupal Access Check Sequence:**
1. Route requirements (`_permission`, `_role`, `_user_is_logged_in`)
2. Custom access callbacks (`_custom_access`)
3. Controller access checks (if any)
4. Entity access (if route has entity parameters)

**For `/vendor/dashboard`:**
- No route requirements (only `_custom_access`)
- `VendorConsoleAccess::access()` is called with `AccountInterface $account`
- If `$account->id() === 0`, access will be **FORBIDDEN** (unless UID 1)

### üß™ DIAGNOSTIC INSTRUMENTATION ADDED

**File:** `web/modules/custom/myeventlane_vendor/src/Access/VendorConsoleAccess.php` (lines 31-46)

Enhanced logging to track:
- Route name
- Host
- UID
- Authentication state
- Roles
- Permission checks

**To Verify:**
Check logs: `ddev drush wd-show vendor_access`

**Expected Log Pattern if Anonymous:**
```
VendorConsoleAccess::access called
  route_name: myeventlane_vendor.console.dashboard
  host: vendor.myeventlane.ddev.site
  uid: 0
  is_authenticated: FALSE
  roles: anonymous
  has_vendor_console_permission: FALSE
VendorConsoleAccess: FORBIDDEN for UID 0 (no permission)
```

---

## STEP 4 ‚Äî ACCESS RESULT CACHE CONTEXT VERIFICATION

### ‚úÖ CONFIRMED FACTS

**VendorConsoleAccess Return Values:**
- `AccessResult::allowed()->cachePerPermissions()`
- `AccessResult::forbidden()->cachePerPermissions()`

**Cache Contexts:**
- `cachePerPermissions()` adds `'user.permissions'` cache context
- This ensures access results are cached **per user permission set**, not per user ID
- **However:** If user is anonymous on vendor domain, the cache key will be different than authenticated user on public domain

### ‚ö†Ô∏è CACHE CONTEXT ANALYSIS

**Cache Key Components:**
- Route: `myeventlane_vendor.console.dashboard`
- User permissions: Anonymous users have different permissions than authenticated
- Result: Access results are **correctly isolated** by permission set

**Conclusion:** Access result caching is **NOT** the root cause. The cache contexts are correct.

---

## STEP 5 ‚Äî DOMAIN REDIRECT FEEDBACK LOOP CHECK

### ‚úÖ CONFIRMED FACTS

**VendorDomainSubscriber Redirect Logic:**
- Lines 118-130: Root path redirect (vendor domain root ‚Üí dashboard)
- Lines 174-179: Vendor routes on public domain ‚Üí redirect to vendor domain
- Lines 188-201: Anonymous users on vendor routes ‚Üí redirect to login

**Login Route Handling:**
- `user.login` is in `ALLOWED_ON_BOTH` array (line 61)
- Login form should be accessible on both domains
- **However:** If session cookie is not shared, login on vendor domain creates a **new session**

### ‚ö†Ô∏è POTENTIAL REDIRECT LOOP

**Scenario:**
1. User logs in on `myeventlane.ddev.site` ‚Üí Session cookie set with `SameSite=Lax`
2. User navigates to `vendor.myeventlane.ddev.site/vendor/dashboard`
3. Browser **does not send** session cookie (cross-site, SameSite=Lax blocks it)
4. Drupal sees anonymous user ‚Üí Redirects to `/user/login?destination=/vendor/dashboard`
5. User logs in on vendor domain ‚Üí **New session created** (different session ID)
6. After login, redirects to `/vendor/dashboard`
7. **If session still not shared**, loop continues

**Evidence Needed:**
- Check browser DevTools ‚Üí Application ‚Üí Cookies
- Verify if two different session cookies exist:
  - `SESS...` for `myeventlane.ddev.site`
  - `SESS...` for `vendor.myeventlane.ddev.site`

---

## STEP 6 ‚Äî HARD EVIDENCE SUMMARY

### ‚úÖ CONFIRMED FACTS

1. **Session cookie domain is configured:** `.myeventlane.ddev.site` ‚úÖ
2. **Cookie SameSite is set to 'Lax':** ‚ùå (blocks cross-domain)
3. **Cookie Secure is set to FALSE:** ‚ö†Ô∏è (acceptable for DDEV, but incompatible with SameSite=None)
4. **settings.ddev.php OVERRIDES settings.php:** ‚úÖ (confirmed by file load order)
5. **VendorDomainSubscriber runs at priority 30:** ‚úÖ (after session init)
6. **VendorConsoleAccess checks account->id():** ‚úÖ (will fail if UID 0)
7. **Route uses _custom_access:** ‚úÖ (VendorConsoleAccess::access)
8. **Access result cache contexts are correct:** ‚úÖ (cachePerPermissions)

### ‚ùå DISPROVEN ASSUMPTIONS

1. **"Session cookie is shared across domains":** ‚ùå DISPROVEN
   - SameSite=Lax prevents cross-domain cookie sending
   - Browser will not send cookie from `myeventlane.ddev.site` to `vendor.myeventlane.ddev.site`

2. **"Cookie domain configuration is active":** ‚ö†Ô∏è PARTIALLY TRUE
   - Domain is correct (`.myeventlane.ddev.site`)
   - But SameSite=Lax overrides the cross-domain behavior

### ‚ö†Ô∏è PROBABLE ROOT CAUSE(S) ‚Äî RANKED BY EVIDENCE

#### üî¥ ROOT CAUSE #1: Session Cookie SameSite Configuration (95% confidence)

**Evidence:**
- `settings.ddev.php` sets `cookie_samesite: 'Lax'`
- Modern browsers block cross-site cookies with SameSite=Lax
- File load order confirms this is the active configuration
- This is the **only** configuration issue that would cause the exact symptom described

**Impact:**
- User authenticated on public domain cannot access vendor domain
- Browser does not send session cookie on cross-domain navigation
- Drupal loads anonymous user (UID 0)
- Access check fails ‚Üí User redirected to login

**Fix Required:**
- Remove or modify `settings.ddev.php` session configuration
- Ensure `cookie_samesite: 'None'` and `cookie_secure: TRUE` are active
- **OR** use a different approach (shared session storage, proxy, etc.)

#### üü° ROOT CAUSE #2: Session Not Initialized on Vendor Domain (60% confidence)

**Evidence:**
- If cookie is not sent, session handler has no session ID
- AccountProxy loads anonymous user by default
- VendorDomainSubscriber sees anonymous user

**Impact:**
- Same as Root Cause #1 (they are related)

**Fix Required:**
- Fix Root Cause #1 (cookie configuration) will resolve this

#### üü¢ ROOT CAUSE #3: Access Result Caching (30% confidence)

**Evidence:**
- Cache contexts are correct (`cachePerPermissions`)
- Different permission sets = different cache keys
- **However:** If anonymous user's access result is cached, it could affect subsequent requests

**Impact:**
- Minimal (cache contexts should prevent this)

**Fix Required:**
- Not necessary if Root Cause #1 is fixed

### üß™ SINGLE MOST LIKELY FIX

**Action:** Remove or modify session cookie configuration in `settings.ddev.php`

**Options:**

**Option A: Remove session config from settings.ddev.php** (Recommended)
- Delete lines 49-54 from `settings.ddev.php`
- Let `settings.php` configuration be active
- **Risk:** DDEV may regenerate the file

**Option B: Modify settings.ddev.php to merge, not override**
- Change array assignment to conditional merge
- Only set if not already defined
- **Risk:** Still may be overwritten by DDEV

**Option C: Move session config to settings.local.php** (Safest)
- Create `settings.local.php`
- Add session configuration there
- Loads last, will override everything
- **Risk:** Must be manually maintained

**Option D: Use DDEV configuration override**
- Configure DDEV to not generate session settings
- Or use DDEV hooks to modify settings.ddev.php after generation

### ‚ùì WHAT CANNOT BE CONCLUDED YET

1. **Actual runtime session cookie values:**
   - Need to check browser DevTools ‚Üí Application ‚Üí Cookies
   - Verify cookie domain, SameSite, Secure flags in actual HTTP response

2. **Session ID consistency:**
   - Need log output from diagnostic instrumentation
   - Verify if same session ID is used on both domains

3. **Browser behavior:**
   - Different browsers may handle SameSite=Lax differently
   - Need to test in actual browser (not just configuration)

4. **DDEV-specific behavior:**
   - DDEV may have additional session handling
   - Need to verify if DDEV modifies session configuration at runtime

---

## RECOMMENDED NEXT STEPS

1. **Immediate:** Review diagnostic logs after test navigation
   - `ddev drush wd-show vendor_domain_diagnostic`
   - `ddev drush wd-show vendor_access`

2. **Verify:** Check browser cookies in DevTools
   - Navigate to public domain, log in
   - Check cookie: `SESS...` domain, SameSite, Secure flags
   - Navigate to vendor domain
   - Check if cookie is sent in request headers

3. **Fix:** Apply Root Cause #1 fix (session cookie configuration)

4. **Test:** Verify authentication persists across domains

5. **Remove:** Diagnostic logging after issue is resolved

---

## APPENDIX: FILE REFERENCES

- `web/sites/default/settings.php` (lines 58-74)
- `web/sites/default/settings.ddev.php` (lines 49-54)
- `web/modules/custom/myeventlane_core/src/EventSubscriber/VendorDomainSubscriber.php`
- `web/modules/custom/myeventlane_vendor/src/Access/VendorConsoleAccess.php`
- `web/modules/custom/myeventlane_vendor/myeventlane_vendor.routing.yml` (lines 218-225)

---

**Report Status:** ‚úÖ Complete  
**Diagnostic Instrumentation:** ‚úÖ Added  
**Ready for Testing:** ‚úÖ Yes

